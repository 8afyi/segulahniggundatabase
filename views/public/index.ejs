<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Segulah Niggun Database</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <script src="/app.js" defer></script>
  </head>
  <body>
    <div class="site-shell">
      <%- include("../partials/site-header", {
        headerAction: publicHeaderAction,
        headerMetaText: publicViewerEmail
          ? `Signed in as ${publicViewerEmail}. Browse niggunim used at Segulah!`
          : "Browse niggunim used at Segulah!"
      }) %>

      <main class="wrap shell-main">
        <h1 class="sr-only">Segulah Niggun Database</h1>
        <%- include('../partials/flash', { flash: flash }) %>

        <section class="panel panel-soft collapsible-panel">
          <details class="filter-accordion" open>
            <summary class="filter-accordion-summary">
              <span class="filter-accordion-title"><%= isAdvancedSearch ? 'Advanced Search' : 'Find Niggunim' %></span>
              <span class="filter-accordion-toggle" aria-hidden="true"></span>
            </summary>
            <form method="get" action="<%= searchPath %>" class="filter-grid filter-accordion-content">
              <label>
                Search title, notes, singer, or composer
                <input type="text" name="q" value="<%= filters.searchQuery %>" placeholder=" " />
              </label>

              <label>
                Tempo
                <select name="tempo">
                  <option value="">All</option>
                  <% for (const tempo of tempoOptions) { %>
                    <option value="<%= tempo %>" <%= filters.tempo === tempo ? 'selected' : '' %>><%= tempo %></option>
                  <% } %>
                </select>
              </label>

              <label>
                Mode
                <select name="mode">
                  <option value="">All</option>
                  <% for (const mode of modeOptions) { %>
                    <option value="<%= mode %>" <%= filters.mode === mode ? 'selected' : '' %>><%= mode %></option>
                  <% } %>
                </select>
              </label>

              <% if (isAdvancedSearch) { %>
                <label>
                  Meter
                  <select name="meter">
                    <option value="">All</option>
                    <% for (const meter of meterOptions) { %>
                      <option value="<%= meter %>" <%= filters.meter === meter ? 'selected' : '' %>><%= meter %></option>
                    <% } %>
                  </select>
                </label>

                <label>
                  Singer
                  <input
                    type="text"
                    name="singer"
                    value="<%= filters.singer %>"
                    list="public-singer-options"
                    placeholder="All singers"
                  />
                </label>

                <label>
                  Composer
                  <input
                    type="text"
                    name="author"
                    value="<%= filters.author %>"
                    list="public-author-options"
                    placeholder="All composers"
                  />
                </label>

                <datalist id="public-singer-options">
                  <% for (const singer of singers) { %>
                    <option value="<%= singer %>"></option>
                  <% } %>
                </datalist>

                <datalist id="public-author-options">
                  <% for (const author of authors) { %>
                    <option value="<%= author %>"></option>
                  <% } %>
                </datalist>

                <label>
                  Sort
                  <select name="sort">
                    <% for (const option of sortOptions) { %>
                      <option value="<%= option.value %>" <%= sortKey === option.value ? 'selected' : '' %>><%= option.label %></option>
                    <% } %>
                  </select>
                </label>

                <fieldset class="checkbox-fieldset">
                  <legend>Service Tags</legend>
                  <div class="checkbox-group">
                    <% for (const occasion of occasionOptions) { %>
                      <label class="checkbox-item">
                        <input
                          type="checkbox"
                          name="occasions"
                          value="<%= occasion %>"
                          <%= filters.occasions.includes(occasion) ? 'checked' : '' %>
                        />
                        <span><%= occasion %></span>
                      </label>
                    <% } %>
                  </div>
                </fieldset>

                <fieldset class="checkbox-fieldset">
                  <legend>Prayer Tags</legend>
                  <div class="checkbox-group">
                    <% for (const prayerTime of prayerTimeOptions) { %>
                      <label class="checkbox-item">
                        <input
                          type="checkbox"
                          name="prayerTimes"
                          value="<%= prayerTime %>"
                          <%= filters.prayerTimes.includes(prayerTime) ? 'checked' : '' %>
                        />
                        <span><%= prayerTime %></span>
                      </label>
                    <% } %>
                  </div>
                </fieldset>
              <% } %>

              <div class="filter-actions">
                <button type="submit"><%= isAdvancedSearch ? 'Apply Filters' : 'Search' %></button>
                <a href="<%= searchPath %>" class="button-secondary">Clear</a>
                <% if (isAdvancedSearch) { %>
                  <a href="<%= basicSearchUrl %>" class="button-secondary">Basic Search</a>
                <% } else { %>
                  <a href="<%= advancedSearchUrl %>" class="button-secondary">Advanced Search</a>
                <% } %>
              </div>
            </form>
          </details>
        </section>

        <section>
          <h2>Results (<%= pagination.totalCount %>)</h2>

          <% if (pagination.totalCount > 0) { %>
            <% const pageStart = pagination.offset + 1; %>
            <% const pageEnd = pagination.offset + niggunim.length; %>
            <p class="muted">Showing <%= pageStart %>-<%= pageEnd %> of <%= pagination.totalCount %> (page <%= pagination.page %> of <%= pagination.totalPages %>)</p>
          <% } %>

          <% if (activeFilterChips && activeFilterChips.length > 0) { %>
            <div class="active-filter-bar" aria-label="Active filters">
              <span class="active-filter-label">Active filters:</span>
              <% for (const chip of activeFilterChips) { %>
                <a href="<%= chip.url %>" class="tag-chip tag-chip-link filter-chip-remove" aria-label="Remove filter <%= chip.label %>">
                  <%= chip.label %> &times;
                </a>
              <% } %>
              <a href="<%= searchPath %>" class="button-secondary active-filter-clear">Clear all</a>
            </div>
          <% } %>

          <% if (niggunim.length === 0) { %>
            <div class="panel">
              <p>No niggunim matched your search.</p>
            </div>
          <% } else { %>
            <div class="table-wrap">
              <table class="results-table">
                <caption class="sr-only">Niggun results listing</caption>
                <thead>
                  <tr>
                    <th scope="col">Title</th>
                    <th scope="col">Composers</th>
                    <th scope="col">Tempo</th>
                    <th scope="col">Preview</th>
                  </tr>
                </thead>
                <tbody>
                  <% for (const niggun of niggunim) { %>
                    <tr>
                      <td data-label="Title" class="results-title-cell">
                        <a href="<%= buildNiggunPublicPath(niggun) %>"><%= niggun.title %></a>
                        <% const tagItems = []; %>
                        <% for (const occasionTag of niggun.occasions) { %>
                          <% tagItems.push({ type: 'occasion', value: occasionTag }); %>
                        <% } %>
                        <% for (const prayerTimeTag of niggun.prayerTimes) { %>
                          <% tagItems.push({ type: 'prayerTime', value: prayerTimeTag }); %>
                        <% } %>
                        <div class="result-tags-line">
                          <% if (tagItems.length) { %>
                            <% for (const tagItem of tagItems) { %>
                              <a
                                href="/advanced-search?<%= tagItem.type === 'occasion' ? 'occasions' : 'prayerTimes' %>=<%= encodeURIComponent(tagItem.value) %>"
                                class="tag-chip tag-chip-link"
                              >
                                <%= tagItem.value %>
                              </a>
                            <% } %>
                          <% } else { %>
                            <span class="muted">No tags</span>
                          <% } %>
                        </div>
                      </td>
                      <td data-label="Composers"><%= niggun.authors.join(', ') %></td>
                      <td data-label="Tempo"><%= niggun.tempo || 'N/A' %></td>
                      <td data-label="Preview" class="audio-preview-cell">
                        <button
                          type="button"
                          class="button-secondary audio-preview-button"
                          data-audio-button
                          data-play-label="Play"
                          data-pause-label="Pause"
                          data-play-aria-label="Play preview for <%= niggun.title %>"
                          data-pause-aria-label="Pause preview for <%= niggun.title %>"
                          aria-pressed="false"
                          aria-label="Play preview for <%= niggun.title %>"
                        >
                          Play
                        </button>
                        <audio preload="none" src="/media/<%= niggun.audioPath %>" data-audio-player class="audio-preview-player"></audio>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          <% } %>

          <% if (pagination.totalPages > 1) { %>
            <nav class="pagination" aria-label="Result pages">
              <% if (pagination.hasPrevious) { %>
                <a href="<%= buildSearchUrl(pagination.previousPage) %>" class="button-secondary">Previous</a>
              <% } %>

              <span class="pagination-status">Page <%= pagination.page %> of <%= pagination.totalPages %></span>

              <% if (pagination.hasNext) { %>
                <a href="<%= buildSearchUrl(pagination.nextPage) %>" class="button-secondary">Next</a>
              <% } %>
            </nav>
          <% } %>
        </section>
      </main>

      <%- include('../partials/site-footer') %>
    </div>
  </body>
</html>
