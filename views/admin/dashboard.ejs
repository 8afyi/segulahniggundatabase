<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard | Segulah Niggun Database</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/app.js" defer></script>
  </head>
  <body>
    <div class="site-shell">
      <header class="site-header">
        <div class="wrap">
          <div class="brand-row">
            <a href="/" class="brand-link" aria-label="Segulah Niggun Database home">
              <img src="/assets/segulah-wide.jpg" alt="Segulah" class="brand-logo" />
            </a>
            <form method="post" action="/admin/logout">
              <%- include('../partials/csrf-field', { csrfToken: csrfToken }) %>
              <button type="submit" class="button-secondary">Sign out</button>
            </form>
          </div>
          <p class="admin-meta">Admin dashboard. Signed in as <strong><%= currentUser ? currentUser.username : '' %></strong></p>
        </div>
      </header>

      <main class="wrap shell-main">
        <%- include('../partials/flash', { flash: flash }) %>

        <nav class="panel panel-soft admin-nav" aria-label="Admin sections">
          <% for (const item of adminNavigation || []) { %>
            <a href="<%= item.href %>" class="admin-nav-link <%= item.active ? 'is-active' : '' %>">
              <%= item.label %>
            </a>
          <% } %>
        </nav>

        <% if (adminSection === 'add') { %>
          <section class="panel panel-soft" id="niggunim">
            <h2>Add Niggun</h2>
            <form method="post" action="/admin/niggunim" enctype="multipart/form-data" class="stack-form">
              <%- include('../partials/csrf-field', { csrfToken: csrfToken }) %>
              <input type="hidden" name="returnTo" value="<%= adminReturnTo %>" />
              <label>
                Title (required)
                <input type="text" name="title" required />
              </label>

              <label>
                Singer(s) (required, comma-separated)
                <input type="text" name="singers" required placeholder="Singer One, Singer Two" />
              </label>

              <label>
                Author(s) (required, comma-separated)
                <input type="text" name="authors" required placeholder="Author One, Author Two" />
              </label>

              <fieldset class="checkbox-fieldset">
                <legend>Service Tags</legend>
                <div class="checkbox-group">
                  <% for (const occasion of occasionOptions) { %>
                    <label class="checkbox-item">
                      <input type="checkbox" name="occasions" value="<%= occasion %>" />
                      <span><%= occasion %></span>
                    </label>
                  <% } %>
                </div>
              </fieldset>

              <fieldset class="checkbox-fieldset">
                <legend>Prayer Tags</legend>
                <div class="checkbox-group">
                  <% for (const prayerTime of prayerTimeOptions) { %>
                    <label class="checkbox-item">
                      <input type="checkbox" name="prayerTimes" value="<%= prayerTime %>" />
                      <span><%= prayerTime %></span>
                    </label>
                  <% } %>
                </div>
              </fieldset>

              <label>
                Tempo
                <select name="tempo">
                  <option value="">Select tempo</option>
                  <% for (const tempo of tempoOptions) { %>
                    <option value="<%= tempo %>"><%= tempo %></option>
                  <% } %>
                </select>
              </label>

              <label>
                Key
                <select name="musicalKey">
                  <option value="">Select key</option>
                  <% for (const key of keyOptions) { %>
                    <option value="<%= key %>"><%= key %></option>
                  <% } %>
                </select>
              </label>

              <label>
                Notes / Description
                <textarea name="notes" rows="4" placeholder="Optional notes or description"></textarea>
              </label>

              <label>
                Lyrics (optional)
                <textarea
                  name="lyrics"
                  rows="8"
                  dir="rtl"
                  lang="he"
                  placeholder="Optional lyrics (Hebrew supported)"
                ></textarea>
              </label>

              <label>
                Audio file upload (max 20MB)
                <input type="file" name="audioFile" accept="audio/*" />
              </label>

              <label>
                OR audio URL (http/https)
                <input type="url" name="audioUrl" placeholder="https://example.com/song.mp3" />
              </label>

              <button type="submit">Add Niggun</button>
            </form>
          </section>
        <% } %>

        <% if (adminSection === 'existing') { %>
          <section class="panel">
            <div class="panel-head">
              <h2>Existing Niggunim (<%= pagination.totalCount %>)</h2>
            </div>

            <form method="get" action="/admin/niggunim" class="filter-grid">
              <label>
                Search title, notes, singer, or author
                <input type="text" name="q" value="<%= filters.searchQuery %>" placeholder=" " />
              </label>

              <label>
                Tempo
                <select name="tempo">
                  <option value="">All</option>
                  <% for (const tempo of tempoOptions) { %>
                    <option value="<%= tempo %>" <%= filters.tempo === tempo ? 'selected' : '' %>><%= tempo %></option>
                  <% } %>
                </select>
              </label>

              <label>
                Key
                <select name="key">
                  <option value="">All</option>
                  <% for (const key of keyOptions) { %>
                    <option value="<%= key %>" <%= filters.musicalKey === key ? 'selected' : '' %>><%= key %></option>
                  <% } %>
                </select>
              </label>

              <label>
                Singer
                <input
                  type="text"
                  name="singer"
                  value="<%= filters.singer %>"
                  list="admin-singer-options"
                  placeholder="All singers"
                />
              </label>

              <label>
                Author
                <input
                  type="text"
                  name="author"
                  value="<%= filters.author %>"
                  list="admin-author-options"
                  placeholder="All authors"
                />
              </label>

              <datalist id="admin-singer-options">
                <% for (const singer of singers) { %>
                  <option value="<%= singer %>"></option>
                <% } %>
              </datalist>

              <datalist id="admin-author-options">
                <% for (const author of authors) { %>
                  <option value="<%= author %>"></option>
                <% } %>
              </datalist>

              <label>
                Sort
                <select name="sort">
                  <% for (const option of sortOptions) { %>
                    <option value="<%= option.value %>" <%= sortKey === option.value ? 'selected' : '' %>><%= option.label %></option>
                  <% } %>
                </select>
              </label>

              <fieldset class="checkbox-fieldset">
                <legend>Service Tags</legend>
                <div class="checkbox-group">
                  <% for (const occasion of occasionOptions) { %>
                    <label class="checkbox-item">
                      <input
                        type="checkbox"
                        name="occasions"
                        value="<%= occasion %>"
                        <%= filters.occasions.includes(occasion) ? 'checked' : '' %>
                      />
                      <span><%= occasion %></span>
                    </label>
                  <% } %>
                </div>
              </fieldset>

              <fieldset class="checkbox-fieldset">
                <legend>Prayer Tags</legend>
                <div class="checkbox-group">
                  <% for (const prayerTime of prayerTimeOptions) { %>
                    <label class="checkbox-item">
                      <input
                        type="checkbox"
                        name="prayerTimes"
                        value="<%= prayerTime %>"
                        <%= filters.prayerTimes.includes(prayerTime) ? 'checked' : '' %>
                      />
                      <span><%= prayerTime %></span>
                    </label>
                  <% } %>
                </div>
              </fieldset>

              <div class="filter-actions">
                <button type="submit">Apply Filters</button>
                <a href="/admin/niggunim" class="button-secondary">Clear</a>
              </div>
            </form>

            <% if (pagination.totalCount > 0) { %>
              <% const pageStart = pagination.offset + 1; %>
              <% const pageEnd = pagination.offset + niggunim.length; %>
              <p class="muted">Showing <%= pageStart %>-<%= pageEnd %> of <%= pagination.totalCount %> (page <%= pagination.page %> of <%= pagination.totalPages %>)</p>
            <% } %>

            <% if (activeFilterChips && activeFilterChips.length > 0) { %>
              <div class="active-filter-bar" aria-label="Active filters">
                <span class="active-filter-label">Active filters:</span>
                <% for (const chip of activeFilterChips) { %>
                  <a href="<%= chip.url %>" class="tag-chip tag-chip-link filter-chip-remove" aria-label="Remove filter <%= chip.label %>">
                    <%= chip.label %> &times;
                  </a>
                <% } %>
                <a href="/admin/niggunim" class="button-secondary active-filter-clear">Clear all</a>
              </div>
            <% } %>

            <% if (niggunim.length === 0) { %>
              <p>No niggunim uploaded yet.</p>
            <% } else { %>
              <div class="table-wrap">
                <table>
                  <caption class="sr-only">Admin niggun listing</caption>
                  <thead>
                    <tr>
                      <th scope="col">Title</th>
                      <th scope="col">Singers</th>
                      <th scope="col">Authors</th>
                      <th scope="col">Service Tags</th>
                      <th scope="col">Prayer Tags</th>
                      <th scope="col">Tempo</th>
                      <th scope="col">Key</th>
                      <th scope="col">Uploaded</th>
                      <th scope="col">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% for (const niggun of niggunim) { %>
                      <tr>
                        <td><a href="<%= buildNiggunPublicPath(niggun) %>" target="_blank" rel="noreferrer"><%= niggun.title %></a></td>
                        <td><%= niggun.singers.join(', ') %></td>
                        <td><%= niggun.authors.join(', ') %></td>
                        <td>
                          <% if (niggun.occasions.length) { %>
                            <div class="tag-list">
                              <% for (const tag of niggun.occasions) { %>
                                <span class="tag-chip"><%= tag %></span>
                              <% } %>
                            </div>
                          <% } else { %>
                            N/A
                          <% } %>
                        </td>
                        <td>
                          <% if (niggun.prayerTimes.length) { %>
                            <div class="tag-list">
                              <% for (const tag of niggun.prayerTimes) { %>
                                <span class="tag-chip"><%= tag %></span>
                              <% } %>
                            </div>
                          <% } else { %>
                            N/A
                          <% } %>
                        </td>
                        <td><%= niggun.tempo || 'N/A' %></td>
                        <td><%= niggun.musicalKey || 'N/A' %></td>
                        <td><%= niggun.createdAtLabel || 'N/A' %></td>
                        <td>
                          <a
                            href="/admin/niggunim/<%= niggun.id %>/edit?returnTo=<%= encodeURIComponent(adminReturnTo) %>"
                            class="button-secondary"
                          >
                            Edit
                          </a>
                          <form method="post" action="/admin/niggunim/<%= niggun.id %>/delete" data-confirm="Delete this niggun? This cannot be undone.">
                            <%- include('../partials/csrf-field', { csrfToken: csrfToken }) %>
                            <input type="hidden" name="returnTo" value="<%= adminReturnTo %>" />
                            <button type="submit" class="button-danger">Delete</button>
                          </form>
                        </td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            <% } %>

            <% if (pagination.totalPages > 1) { %>
              <nav class="pagination" aria-label="Admin niggun pages">
                <% if (pagination.hasPrevious) { %>
                  <a href="<%= buildAdminUrl(pagination.previousPage) %>" class="button-secondary">Previous</a>
                <% } %>

                <span class="pagination-status">Page <%= pagination.page %> of <%= pagination.totalPages %></span>

                <% if (pagination.hasNext) { %>
                  <a href="<%= buildAdminUrl(pagination.nextPage) %>" class="button-secondary">Next</a>
                <% } %>
              </nav>
            <% } %>
          </section>
        <% } %>

        <% if (adminSection === 'users') { %>
          <section class="panel" id="users">
            <h2>User Management</h2>

            <form method="post" action="/admin/users" class="stack-form compact-form">
              <%- include('../partials/csrf-field', { csrfToken: csrfToken }) %>
              <input type="hidden" name="returnTo" value="<%= adminReturnTo %>" />
              <label>
                New username
                <input type="text" name="username" required minlength="3" maxlength="32" />
              </label>

              <label>
                New password
                <input type="password" name="password" required minlength="8" />
              </label>

              <button type="submit">Add User</button>
            </form>

            <div class="table-wrap">
              <table>
                <caption class="sr-only">Admin user listing</caption>
                <thead>
                  <tr>
                    <th scope="col">Username</th>
                    <th scope="col">Created</th>
                    <th scope="col">Reset Password</th>
                    <th scope="col">Delete</th>
                  </tr>
                </thead>
                <tbody>
                  <% for (const user of users) { %>
                    <tr>
                      <td><%= user.username %></td>
                      <td><%= user.createdAtLabel || 'N/A' %></td>
                      <td>
                        <form method="post" action="/admin/users/<%= user.id %>/password" class="user-password-form" data-confirm="Reset password for this user?">
                          <%- include('../partials/csrf-field', { csrfToken: csrfToken }) %>
                          <input type="hidden" name="returnTo" value="<%= adminReturnTo %>" />
                          <input type="password" name="password" required minlength="8" placeholder="New password" />
                          <button type="submit" class="button-secondary">Reset</button>
                        </form>
                      </td>
                      <td>
                        <% if (currentUser && currentUser.id === user.id) { %>
                          <span class="muted">Current user</span>
                        <% } else { %>
                          <form method="post" action="/admin/users/<%= user.id %>/delete" data-confirm="Delete this user?">
                            <%- include('../partials/csrf-field', { csrfToken: csrfToken }) %>
                            <input type="hidden" name="returnTo" value="<%= adminReturnTo %>" />
                            <button type="submit" class="button-danger">Delete</button>
                          </form>
                        <% } %>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </section>
        <% } %>
      </main>

      <%- include('../partials/site-footer') %>
    </div>
  </body>
</html>
