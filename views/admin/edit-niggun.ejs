<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edit Niggun | Segulah Niggun Database</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  </head>
  <body>
    <div class="site-shell">
      <%- include("../partials/site-header", {
        headerAction: { type: "link", href: returnTo, label: "Back to Admin" },
        headerMetaClass: "admin-meta",
        headerMetaText: "Edit niggun and optionally replace audio."
      }) %>

      <main class="wrap shell-main">
        <h1 class="sr-only">Edit Niggun</h1>
        <%- include('../partials/flash', { flash: flash }) %>

        <section class="panel panel-soft">
          <h2>Edit Niggun</h2>

          <form method="post" action="/admin/niggunim/<%= niggun.id %>" enctype="multipart/form-data" class="stack-form">
            <%- include('../partials/csrf-field', { csrfToken: csrfToken }) %>
            <input type="hidden" name="returnTo" value="<%= returnTo %>" />

            <label>
              Title (required)
              <input type="text" name="title" value="<%= niggun.title %>" required />
            </label>

            <label>
              Singer(s) (required, comma-separated)
              <input
                type="text"
                name="singers"
                value="<%= niggun.singers.join(', ') %>"
                required
                placeholder="Singer One, Singer Two"
              />
            </label>

            <label>
              Composer(s) (required, comma-separated)
              <input
                type="text"
                name="authors"
                value="<%= niggun.authors.join(', ') %>"
                required
                placeholder="Composer One, Composer Two"
              />
            </label>

            <fieldset class="checkbox-fieldset">
              <legend>Service Tags</legend>
              <div class="checkbox-group">
                <% for (const occasion of occasionOptions) { %>
                  <label class="checkbox-item">
                    <input
                      type="checkbox"
                      name="occasions"
                      value="<%= occasion %>"
                      <%= niggun.occasions.includes(occasion) ? 'checked' : '' %>
                    />
                    <span><%= occasion %></span>
                  </label>
                <% } %>
              </div>
            </fieldset>

            <fieldset class="checkbox-fieldset">
              <legend>Prayer Tags</legend>
              <div class="checkbox-group">
                <% for (const prayerTime of prayerTimeOptions) { %>
                  <label class="checkbox-item">
                    <input
                      type="checkbox"
                      name="prayerTimes"
                      value="<%= prayerTime %>"
                      <%= niggun.prayerTimes.includes(prayerTime) ? 'checked' : '' %>
                    />
                    <span><%= prayerTime %></span>
                  </label>
                <% } %>
              </div>
            </fieldset>

            <label>
              Tempo
              <select name="tempo">
                <option value="">Select tempo</option>
                <% for (const tempo of tempoOptions) { %>
                  <option value="<%= tempo %>" <%= niggun.tempo === tempo ? 'selected' : '' %>><%= tempo %></option>
                <% } %>
              </select>
            </label>

            <label>
              Mode
              <select name="mode">
                <option value="">Select mode</option>
                <% for (const mode of modeOptions) { %>
                  <option value="<%= mode %>" <%= niggun.mode === mode ? 'selected' : '' %>><%= mode %></option>
                <% } %>
              </select>
            </label>

            <label>
              Meter
              <select name="meter">
                <option value="">Select meter</option>
                <% for (const meter of meterOptions) { %>
                  <option value="<%= meter %>" <%= niggun.meter === meter ? 'selected' : '' %>><%= meter %></option>
                <% } %>
              </select>
            </label>

            <label>
              Notes / Description
              <textarea name="notes" rows="4" placeholder="Optional notes or description"><%= niggun.notes %></textarea>
            </label>

            <label>
              Lyrics (optional)
              <textarea
                name="lyrics"
                rows="8"
                dir="rtl"
                lang="he"
                placeholder="Optional lyrics (Hebrew supported)"
              ><%= niggun.lyrics %></textarea>
            </label>

            <label>
              Scripture References (optional, one per line or comma-separated)
              <textarea
                name="scriptureRefs"
                rows="4"
                placeholder="Psalm 150:1-6&#10;Exodus 15:1"
              ><%= (niggun.scriptureRefs || []).map((item) => item.reference).join('\n') %></textarea>
            </label>

            <div class="panel">
              <h3>Current Audio</h3>
              <% if (niggun.audioPath) { %>
                <audio controls preload="metadata" src="/media/<%= niggun.audioPath %>"></audio>
                <% if (niggun.originalFilename) { %>
                  <p><small>Source file: <%= niggun.originalFilename %></small></p>
                <% } %>
                <% if (niggun.audioSourceUrl) { %>
                  <p><small>Source URL: <%= niggun.audioSourceUrl %></small></p>
                <% } %>
              <% } else { %>
                <p class="draft-pill">DRAFT - no audio uploaded yet.</p>
              <% } %>
            </div>

            <label>
              Replace audio with file upload (max 20MB)
              <input type="file" name="audioFile" accept="audio/*" />
            </label>

            <label>
              OR replace audio using URL (http/https)
              <input type="url" name="audioUrl" placeholder="https://example.com/song.mp3" />
            </label>

            <p class="muted">Leave both audio fields blank to keep the current audio status. Drafts become public after audio is added.</p>

            <div class="action-row">
              <button type="submit">Update Niggun</button>
              <a href="<%= returnTo %>" class="button-secondary">Cancel</a>
            </div>
          </form>
        </section>
      </main>

      <%- include('../partials/site-footer') %>
    </div>
  </body>
</html>
